<template>
   <!-- Navigation -->

   <q-layout>

 <div class="">
   <q-list inset-separator class="no-border">
    <q-item class="q-mx-sm">
        <q-item-main label="Weight">
        <q-item-tile sublabel>
        <numeric-slider color="primary"
            v-model="dailymeasurement.Weight"
            :min="0"
            :max="145"
            :adjustment="0.1"
        />
        </q-item-tile>
        </q-item-main>
    </q-item>
    <q-item class="q-mx-sm">
        <q-item-main label="Neck">
        <q-item-tile sublabel>
          <numeric-slider color="primary"
            v-model="dailymeasurement.NeckCircumference"
            :min="0"
            :max="60"
            :adjustment="0.5"
        />
        </q-item-tile>
        </q-item-main>
    </q-item>
    <q-item class="q-mx-sm">
        <q-item-main label="Belly-button">
        <q-item-tile sublabel>
          <numeric-slider color="primary"
            v-model="dailymeasurement.BellyButtonCircumference"
            :min="0"
            :max="145"
            :adjustment="0.5"
        />
        </q-item-tile>
        </q-item-main>
    </q-item>
    <q-item>
      <q-item-main class="row">
        <div class="col">
          <div class="column">
            Body Fat %
            <q-knob slot="subtitle"
          v-model="BodyFatEstimate"
          :min="0"
          :max="1"
          :color="BodyFatEstimate > .5 ? 'grey-7' : BodyFatEstimate > .4 ? 'deep-purple-11' : BodyFatEstimate > .3 ? 'red' : BodyFatEstimate > .25 ? 'deep-orange' : BodyFatEstimate > .2 ? 'amber' : BodyFatEstimate > .15 ? 'lime' : BodyFatEstimate > .1 ? 'green' : BodyFatEstimate > .05 ? 'blue-grey' : 'purple-14' "
          :readonly="true"
        >{{BFFormatted}}
        <small>({{PrevBFFormatted}})</small>
        </q-knob>
          </div>
        </div>
        <div class="col">
          <div  class="column">
            Fat Free Mass
          </div>
          <div>
            <q-knob
          v-model="FFM"
          :min="0"
          :max="dailymeasurement.Weight"
          :color="FFM - PrevFFM > 0.5 ? 'light-green-8' : PrevFFM - FFM > 0.5 ? 'deep-orange-9' : 'blue-grey-5'"
          :readonly="true"
        >{{FFMFormatted}}
        <small>({{PrevFFMFormatted}})</small>
        </q-knob>
          </div>
        </div>
        <div class="col">
          <div  class="column">
            Fat Mass
          </div>
          <div>
            <q-knob
          v-model="BFM"
          :min="0"
          :max="dailymeasurement.Weight"
          :color="BFM - PrevBFM > 0.5 ? 'deep-orange-9' : PrevBFM - BFM > 0.5 ? 'light-green-8' : 'blue-grey-5'"
          :readonly="true"
        >{{BFMFormatted}}
        <small>({{PrevBFMFormatted}})</small>
        </q-knob>
          </div>
        </div>
        </q-item-main>
    </q-item>
    </q-list>

    </div>
   </q-layout>
</template>
<script>

// import { required } from 'vuelidate/lib/validators'
import {mapGetters, mapState} from 'vuex'
import numericSlider from '../../components/inputs/numeric.slider'
import numeral from 'numeral'
import _ from 'underscore'
// import { ActionSheet } from 'quasar'
export default {
  components: {
    numericSlider
  },
  props: {
    measurementdateid: {
      type: String,
      required: true
    }
  },
  data: function () {
    return {
      dailymeasurement: {
        Weight: 0,
        BellyButtonCircumference: 0,
        NeckCircumference: 0,
        BodyFatPercentage: 0
      },
      previousmeasurement: {
        Weight: 0,
        BellyButtonCircumference: 0,
        NeckCircumference: 0,
        BodyFatPercentage: 0
      },
      height: 0,
      edited: false
    }
  },
  watch: {
    measurementdateid: function (val) {
      if (this.edited !== true) {
        this.fetchStats()
      }
    },
    'Get_Flags.loaded' (newVal, oldVal) {
      if (this.edited !== true) {
        this.fetchStats()
      }
    },
    'GetFlags.Saved' (newVal, oldVal) {
      if (this.GetFlags.Saved === true) {
        this.$fit.notifyPerSecond({
          message: 'Exercise saved',
          icon: 'fa-thumbs-up',
          timeout: 2400,
          type: 'positive',
          color: 'positive'
        })
      }
    },
    'GetFlags.Failed' (newVal, oldVal) {
      if (this.GetFlags.Failed === true) {
        this.$fit.notifyPerSecond({
          message: 'Issue saving',
          icon: 'fa-thumbs-down',
          timeout: 2400,
          type: 'negative',
          color: 'negative'
        })
      }
    }
  },
  computed: {
    ...mapGetters(
      'Stats', ['DailyMeasurement',
        'Get_Flags',
        'Get_DailyMeasurement_Dates']
    ),
    ...mapGetters(
      'AppState', ['GetFlags']
    ),
    ...mapState({
      DailyMeasurement: state => state.Stats.DailyMeasurement
    }),
    BodyFatEstimate () {
      if (this.height !== 0) {
        let height = this.height
        let belly = this.dailymeasurement.BellyButtonCircumference
        let neck = this.dailymeasurement.NeckCircumference
        let ret = (86.01 * Math.log10((belly - neck) / 2.54) - 70.041 * Math.log10(height / 2.54) + 36.76) / 100
        return ret
      } else {
        return 1 / 0
      }
    },
    PrevBodyFatEstimate () {
      if (this.height !== 0) {
        let height = this.height
        let belly = this.previousmeasurement.BellyButtonCircumference
        let neck = this.previousmeasurement.NeckCircumference
        let ret = (86.01 * Math.log10((belly - neck) / 2.54) - 70.041 * Math.log10(height / 2.54) + 36.76) / 100
        return ret
      } else {
        return 1 / 0
      }
    },
    BFFormatted () {
      return numeral(this.BodyFatEstimate).format('0.00%')
    },
    FFM () {
      return this.dailymeasurement.Weight * (1 - this.BodyFatEstimate)
    },
    PrevFFM () {
      return this.previousmeasurement.Weight * (1 - this.PrevBodyFatEstimate)
    },
    PrevBFFormatted () {
      return numeral(this.PrevBodyFatEstimate).format('0.00%')
    },
    FFMFormatted () {
      return numeral(this.FFM).format('0.00') + ' kg'
    },
    PrevFFMFormatted () {
      return numeral(this.PrevFFM).format('0.00')
    },
    BFM () {
      return this.dailymeasurement.Weight * this.BodyFatEstimate
    },
    PrevBFM () {
      return this.previousmeasurement.Weight * this.PrevBodyFatEstimate
    },
    BFMFormatted () {
      return numeral(this.BFM).format('0.00') + ' kg'
    },
    PrevBFMFormatted () {
      return numeral(this.PrevBFM).format('0.00')
    }
  },
  mounted () {
    // this.$API.Initialize()
    // var store = this.$store
    var localVue = this
    var store = this.$store
    let fnSave = function () {
      let payload = {...localVue.Get_DailyMeasurement_Dates[localVue.measurementdateid], ...localVue.dailymeasurement}
      if (typeof payload.MeasurementDate === 'undefined' || payload.MeasurementDate === null) {
        payload.MeasurementDate = new Date()
      } else {
        payload.MeasurementDate = payload.MeasurementDateOriginal
      }
      payload.BodyFatPercentage = localVue.BodyFatEstimate
      store.dispatch('Stats/saveDailyMeasurement', payload)
      // localVue.$q.notify({
      //   html: 'Measurements saved',
      //   icon: 'fa-thumbs-up',
      //   timeout: 2400,
      //   color: '#99d8c9',
      //   bgColor: 'white'
      // })
    }
    this.$store.commit('AppState/SET_SAVE', fnSave)
    let today = this.Get_DailyMeasurement_Dates[localVue.measurementdateid]
    if (typeof today !== 'undefined') {
      today = today.MeasurementDate.substr(0, 10)
    } else {
      today = this.fnDt(this.measurementdateid).toLocaleDateString()
    }
    this.$store.commit('AppState/SET_TITLETEXT', today)
    this.fetchStats()
    // store.dispatch('DailyMeasurement/Set_NewDailyMeasurement')
  },
  beforeDestroy () {
    this.$store.commit('AppState/CLEAR_SAVE')
    this.$store.commit('AppState/CLEAR_TITLETEXT')
  },
  methods: {
    failed () {
      return this.GetFlags.Failed
    },
    saved () {
      return this.GetFlags.Saved
    },
    /// TODO: Move this to an Orca Util
    fnDt: function (intDate) {
      let year = Math.round(intDate / 10000)
      let month = Math.round((intDate - (year * 10000)) / 100)
      let day = intDate - (year * 10000) - (month * 100)
      return new Date(year, month - 1, day)
    },
    fetchStats: function () {
      let stats = this.Get_DailyMeasurement_Dates[this.measurementdateid]
      let localVue = this
      let prevStats = _.chain(this.DailyMeasurement)
        .filter(item => item.MeasurementDateID < localVue.measurementdateid)
        .last()
        .value()
      if (typeof stats !== 'undefined') {
        this.dailymeasurement.Weight = stats.Weight
        this.dailymeasurement.BellyButtonCircumference = stats.BellyButtonCircumference
        this.dailymeasurement.NeckCircumference = stats.NeckCircumference
        this.dailymeasurement.BodyFatPercentage = stats.BodyFatPercentage
      } else {
        if (typeof prevStats !== 'undefined') {
          this.dailymeasurement.Weight = prevStats.Weight
          this.dailymeasurement.BellyButtonCircumference = prevStats.BellyButtonCircumference
          this.dailymeasurement.NeckCircumference = prevStats.NeckCircumference
          this.dailymeasurement.BodyFatPercentage = prevStats.BodyFatPercentage
        }
        // debugger
        // let x = this.$store.getters['Stats/Get_Flags']
        // let y = x
        // x = y
      }
      if (typeof prevStats !== 'undefined') {
        this.previousmeasurement.Weight = prevStats.Weight
        this.previousmeasurement.BellyButtonCircumference = prevStats.BellyButtonCircumference
        this.previousmeasurement.NeckCircumference = prevStats.NeckCircumference
        this.previousmeasurement.BodyFatPercentage = prevStats.BodyFatPercentage
      }
      if (typeof this.$store.getters['Stats/Get_Person_List'][0] !== 'undefined') {
        this.height = this.$store.getters['Stats/Get_Person_List'][0].Height
      }
    }
  },
  beforeRouteLeave (to, from, next) {
    next()
  }
}
</script>
<style>
/* This is where your CSS goes */
</style>
