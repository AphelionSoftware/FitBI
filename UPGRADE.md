# FitBI — Full Stack Upgrade Guide

This document covers the complete upgrade from the ~2018 stack to current stable versions (Feb 2026).

---

## Summary of Changes

| Component | Before | After |
|---|---|---|
| **Azure Functions** | v1 / .NET Framework 4.6.1 | v4 Isolated Worker / .NET 8 |
| **Dapper** | 1.50.4 | 2.1.35 |
| **Newtonsoft.Json** | 10.0.3 | 13.0.3 |
| **SQL Client** | `System.Data.SqlClient` (inbox) | `Microsoft.Data.SqlClient` 5.2.2 |
| **TemplateCreator** | .NET Framework 4.6.1 WinForms | .NET 8 WinForms (`net8.0-windows`) |
| **SMO (TemplateCreator)** | GAC `14.100.0.0` | NuGet `Microsoft.SqlServer.SqlManagementObjects` 171.x |
| **Frontend framework** | Vue 2.5 + Quasar 0.14 | Vue 3.5 + Quasar 2.17 |
| **Build tool** | Webpack 2 + Babel 6 | Vite 6 (via `@quasar/app-vite`) |
| **State management** | Vuex 3 | Pinia 2 |
| **Routing** | vue-router 2 | vue-router 4 |
| **Firebase SDK** | 3.7 (legacy namespace API) | 11.2 (modular tree-shakeable API) |
| **HTTP client** | axios 0.17 | axios 1.7 |
| **Date library** | moment.js 2 (maintenance-only) | Day.js 1.11 |
| **Form validation** | vuelidate 0.6 | vuelidate 2.0 |
| **Docker base image** | `quasarframework/client-dev:latest` | `node:20-alpine` (multi-stage) |
| **Docker Compose** | v2 | v3.9 |
| **Node.js** | ~8 era (unspecified) | 20 LTS |

---

## 1. Azure Functions Backend — Breaking Changes

### 1.1 Isolated Worker Model

Azure Functions v4 uses the **isolated worker model** by default. The in-process model (v1/v2/v3) is retired.

**Changes already applied in this PR:**
- All function classes converted from `static` to instance classes with constructor injection.
- `TraceWriter log` parameter removed; `ILogger<T>` injected via DI.
- `[FunctionName("X")]` → `[Function("X")]`.
- `HttpRequestMessage` → `HttpRequestData` (from `Microsoft.Azure.Functions.Worker.Http`).
- `HttpResponseMessage` → `HttpResponseData`.
- `req.CreateResponse(statusCode, JSON)` → explicit `WriteStringAsync` pattern.
- `System.Configuration.ConfigurationManager` → `Environment.GetEnvironmentVariable(...)`.
- `System.Data.SqlClient` → `Microsoft.Data.SqlClient`.
- New `Program.cs` entry point with `HostBuilder`.

### 1.2 Configuration Migration

**Before:** `ConnectionStrings` in `web.config` / `App.config`.

**After:** Azure Functions v4 reads from `local.settings.json` (local dev) and Azure App Settings (cloud).

Update your `local.settings.json`:
```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "dotnet-isolated",
    "FitDB_conn": "<your-sql-connection-string>",
    "sp_Core": "API.sp_Core",
    "sp_Init": "API.sp_Init",
    "sp_LatestTimestamps": "API.sp_LatestTimestamps"
  }
}
```

### 1.3 T4 Templates Need Updating

The merge class `.cs` files in `mergeClasses/` are auto-generated by T4 templates (`.tt` files). The generated files have been updated in this PR, but the **T4 templates themselves** must also be updated to generate v4-compatible code, otherwise the next `Run Custom Tool` in Visual Studio will overwrite the changes.

Key T4 template changes needed:
- In `_mergeClassCreate.tt`: Change class generation from `public static class` to instance class with `ILogger<T>` constructor.
- Replace `HttpRequestMessage`/`HttpResponseMessage` template output with `HttpRequestData`/`HttpResponseData`.
- Replace `TraceWriter log` with DI-injected logger.
- Replace `ConfigurationManager` with `Environment.GetEnvironmentVariable`.

### 1.4 `Microsoft.Data.SqlClient` vs `System.Data.SqlClient`

`Microsoft.Data.SqlClient` is the active, cross-platform SQL client. The API is largely identical, but note:
- Connection string `Encrypt=false` is now required explicitly if not using TLS (previously defaulted to `false`, now defaults to `true`).
- Add `TrustServerCertificate=True` for local development without a proper cert.

---

## 2. TemplateCreator — Breaking Changes

### 2.1 SDK-Style Project Format

The `.csproj` has been converted from the old Visual Studio 2017 XML format to the SDK-style format. This means:
- Files are included by glob convention (no explicit `<Compile Include="..." />` needed).
- `Properties/AssemblyInfo.cs` can be deleted — attributes are now generated automatically.
- `Properties/Resources.resx` and `Runner.resx` are still needed and will be picked up automatically.

### 2.2 SQL Server SMO

GAC references to `Microsoft.SqlServer.Smo` v14 (SQL Server 2017) have been replaced with:
```
Microsoft.SqlServer.SqlManagementObjects 171.31.0
```
This includes `ConnectionInfo`, `Management.Sdk.Sfc`, and `Smo` assemblies. The API is backwards-compatible for basic schema introspection.

### 2.3 Windows-Only Build

The `net8.0-windows` target means this project can only be built on Windows. This is expected for a WinForms application. CI/CD builds should run on `windows-latest`.

---

## 3. Frontend (FitBi.Quasar) — Breaking Changes

This is the most significant change. The frontend requires a **full rewrite** of bootstrapping code and a store migration.

### 3.1 Quasar 0.14 → Quasar 2.x

Quasar 2 is built for Vue 3. It is not backwards compatible with Quasar 0.x or 1.x.

**Required steps:**
1. Delete the `build/` directory — Quasar 2 uses Vite, not Webpack.
2. Delete `config/` directory — Quasar 2 uses `quasar.config.js` at the root.
3. Create `quasar.config.js`:
```js
import { defineConfig } from '#q-app/wrappers'
export default defineConfig((ctx) => ({
  framework: {
    config: {},
    plugins: ['Notify', 'Loading'],
    iconSet: 'material-icons',
  },
  boot: ['axios', 'firebase', 'pinia'],
  css: ['app.css'],
  build: {
    target: { browser: ['es2022'] },
    vueRouterMode: 'history',
  },
  devServer: { port: 8080, open: true },
}))
```
4. Update `src/main.js` → `src/main.ts` (recommended) with the Quasar 2 app bootstrap.

### 3.2 Vue 2 → Vue 3

All Vue files need to be reviewed for the Vue 3 breaking changes:

| Vue 2 | Vue 3 equivalent |
|---|---|
| `Vue.use(...)` | `app.use(...)` |
| `new Vue({ ... })` | `createApp({ ... })` |
| `this.$set(obj, key, val)` | `obj[key] = val` (reactive by default in Vue 3) |
| Filters (`\| filterName`) | Computed properties or methods |
| `v-model` (single binding) | `v-model` (multiple with args, e.g. `v-model:value`) |
| `beforeDestroy` | `beforeUnmount` |
| `destroyed` | `unmounted` |
| `$listeners` | Merged into `$attrs` |
| `$children` | Not available — use `provide`/`inject` or template refs |

### 3.3 Vuex 3 → Pinia 2

Vuex has been replaced by Pinia, which is the official Vue 3 state management solution.

**Migration steps:**
1. For each Vuex module (Core, Exercise, Program, Stats, WeightMeasurement), create a Pinia store:
```js
// Before (Vuex)
export const store = { state: {}, mutations: {}, actions: {}, getters: {} }

// After (Pinia)
import { defineStore } from 'pinia'
export const useCoreStore = defineStore('core', {
  state: () => ({ ... }),
  getters: { ... },
  actions: { ... },
})
```
2. Remove `vuex-map-fields` and `vuex-router-sync` (not needed with Pinia + vue-router 4).
3. The T4-generated Vuex store JS files in `jsGenStore/` and the T4 template `_storeGenerator.tt` also need updating to generate Pinia stores.

### 3.4 Vue Router 2 → 4

```js
// Before
import Router from 'vue-router'
Vue.use(Router)
const router = new Router({ routes: [...] })

// After
import { createRouter, createWebHistory } from 'vue-router'
const router = createRouter({
  history: createWebHistory(),
  routes: [...],
})
```

### 3.5 Firebase 3 → 11 (Modular API)

Firebase 11 uses a modular, tree-shakeable API. The namespace API (`firebase.auth()`, `firebase.firestore()`) is gone.

```js
// Before (Firebase 3 namespace API)
import firebase from 'firebase'
firebase.initializeApp(config)
const db = firebase.database()

// After (Firebase 11 modular API)
import { initializeApp } from 'firebase/app'
import { getDatabase } from 'firebase/database'
const app = initializeApp(config)
const db = getDatabase(app)
```

Vuefire 3 supports Firebase 11 and provides Vue 3 composables:
```js
import { useDocument } from 'vuefire'
```

### 3.6 moment.js → Day.js

```js
// Before
import moment from 'moment'
moment(date).format('YYYY-MM-DD')

// After
import dayjs from 'dayjs'
dayjs(date).format('YYYY-MM-DD')
```

Day.js is API-compatible with moment for most common use cases.

### 3.7 Axios 0.17 → 1.x

Axios 1.x is mostly backwards-compatible, but note:
- Error response handling — `error.response` is still the pattern.
- CSRF handling and config defaults have minor changes.

### 3.8 Removed Packages

These packages are removed and should not be reinstalled:

| Package | Reason |
|---|---|
| `azure-mobile-apps-client` | Azure Mobile Apps is retired. Use direct REST calls via axios. |
| `fastclick` | Modern mobile browsers handle touch delays natively. |
| `underscore` / `vue-underscore` | Use native JS array/object methods (ES2022). |
| `vuex-map-fields` | Not needed with Pinia. |
| `vuex-router-sync` | Not needed with vue-router 4 (use `useRoute()`). |
| `babel-*` (all) | Replaced by Vite's native ESM + esbuild transpilation. |
| `webpack` + loaders | Replaced by `@quasar/app-vite` + Vite 6. |
| `vue-config` | Non-standard, not maintained. |
| `material-design-icons` | Now part of `@quasar/extras`. Import via Quasar config. |
| `roboto-fontface` | Now part of `@quasar/extras`. Import via Quasar config. |
| `quasar-extras` (old) | Replaced by `@quasar/extras`. |
| `quasar-framework` | Replaced by `quasar` (unified package in v2). |

### 3.9 ESLint 3 → 9

ESLint 9 uses a flat config (`eslint.config.js`) instead of `.eslintrc.*`.

Create `eslint.config.js`:
```js
import pluginVue from 'eslint-plugin-vue'
export default [
  ...pluginVue.configs['flat/recommended'],
  { rules: { 'vue/multi-word-component-names': 'off' } },
]
```

---

## 4. Security Notes

The exploration found that **API access codes and user IDs are hardcoded** in `src/config.js`. These should be moved to environment variables before deploying:

- Use `.env` files with Vite's `import.meta.env.VITE_*` pattern.
- Never commit secrets to source control.

---

## 5. CI/CD

No CI/CD pipeline exists. Recommended additions:

### GitHub Actions (suggested `.github/workflows/ci.yml`):
```yaml
on: [push, pull_request]
jobs:
  backend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
      - run: dotnet build FitAPI.Functions/FitAPIFunctions.sln

  frontend:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm' }
      - run: npm ci
        working-directory: FitBi.Quasar
      - run: npm run build
        working-directory: FitBi.Quasar

  template-creator:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with: { dotnet-version: '8.0.x' }
      - run: dotnet build TemplateCreator/TemplateCreator.csproj
```

---

## 6. Upgrade Order Recommendation

1. **Backend first** — The Azure Functions changes are self-contained and testable independently.
2. **TemplateCreator** — Update and verify schema introspection works with SMO 171.
3. **T4 Templates** — Update `.tt` files to generate v4 function code and Pinia stores.
4. **Frontend** — Migrate bootstrapping, then stores (Vuex→Pinia), then Firebase, then components.
5. **Add CI/CD** — Set up GitHub Actions as described above.
